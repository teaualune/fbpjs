/*
    FBP.js
    http://github.com/teaualune/fbpjs
    MIT License
*/
!function(){var a={},b={};!function(a,b){var c=function(a,b){var c;for(c in a)a.hasOwnProperty(c)&&b(c)},d=function(a){var b=0;return c(a,function(){b+=1}),b},e=function(a){var b,c;return 1===arguments.length?(b=a.name,c=a.port):(b=arguments[0],c=arguments[1]),b+"."+c},f=function(a){var b=a.split(".");return{name:b[0],port:b[1]}};b.objIterate=c,b.objLength=d,b.portEncode=e,b.portDecode=f}(a,b),function(a,b){var c=function(c,d){var e=this,f=a.component(c.name);e.inputs[c.name][c.port]=d,b.objLength(e.inputs[c.name])===f.inPorts.length&&e.invokeComponent(f)},d=function(a){var c,d,e=this,f=a.inPorts,h=a.outPorts,i=[],j=0;for(j;j<f.length;j+=1)i[j]=e.inputs[a.name][f[j]];for(j=0;j<h.length;j+=1)c=b.portEncode(a.name,h[j]),d=e.arcs[c],i[j+f.length]=g(d).bind(e);a.body.apply(e.states[a.name],i)},e=function(a,b,c){var d=this,e=c||null,f={interval:Date.now()-d.tic};e||(d.inputs[d.nname][b]=a,f.output=a,f.port=b),d.callback.apply(d,[e,f])},f=function(a){if(a)throw a},g=function(a){return function(c,d){var e=this;c?e.sendOutput(null,null,c):a.end?e.sendOutput(d,b.portEncode(a)):e.addInput(a,d)}};b.Runtime=function(g,h){var i=this;i.nname=g.name,i.addInput=c,i.invokeComponent=d,i.sendOutput=e,i.arcs=g.arcs,i.states={},i.inputs={},i.callback=h||f,i.tic=Date.now(),b.objIterate(g.components,function(b){i.states[b]=a.component(b).state||{},i.inputs[b]={}}),i.inputs[g.name]={}}}(a,b),function(a,b){var c={},d={},e=function(a,c){var d=new b.Runtime(this,c);b.objIterate(a,function(b){d.addInput(d.arcs[b],a[b])})},f=function(a,c){var f={},g={},h={init:function(a,c){f[a]=!0,g[b.portEncode(a,c)]={name:a,port:c}},connect:function(a,c,d,e){var h=b.portEncode(a,c);f[d]=!0,g[h]={name:d,port:e}},end:function(a,c){g[b.portEncode(a,c)]={name:a,port:c,end:!0}}},i={name:a,outputs:{}};return c(h),i.components=f,i.arcs=g,i.go=e.bind(i),d[a]=i,i},g=function(a){var c,f={name:a.name,outputs:{},components:{},arcs:{}},g="string"==typeof a.init?[a.init]:a.init,h="string"==typeof a.end?[a.end]:a.end;for(c=0;c<g.length;c+=1)f.arcs[g[c]]=b.portDecode(g[c]),f.components[f.arcs[g[c]].name]=!0;for(b.objIterate(a.connections,function(c){f.arcs[c]=b.portDecode(a.connections[c]),f.components[f.arcs[c].name]=!0}),c=0;c<h.length;c+=1)f.arcs[h[c]]=b.portDecode(h[c]),f.arcs[h[c]].end=!0;return f.go=e.bind(f),d[f.name]=f,f};a.component=function(a){if("string"==typeof a)return c[a];var b=a.name,d=a.body,e=a.state||{},f=null,g=null;if(c[b])throw"component has already defined";if(f="string"==typeof a.inPorts?[a.inPorts]:a.inPorts,g="string"==typeof a.outPorts?[a.outPorts]:a.outPorts,d.length!==f.length+g.length)throw"number of ports do not match between definition and function arguments";c[b]={name:b,inPorts:f,outPorts:g,body:d,state:e}},a.network=function(a){return d[a]},a.define=function(){var a;return a=2===arguments.length&&"string"==typeof arguments[0]?f(arguments[0],arguments[1]):g(arguments[0])}}(a,b);var c=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=a),exports.FBP=a):c.FBP=a}();