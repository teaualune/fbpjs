/*
    FBP.js
    http://github.com/teaualune/fbpjs
    MIT License
*/
!function(){var a={},b={};!function(a,b){var c=function(a,b){var c;for(c in a)a.hasOwnProperty(c)&&b(c)},d=function(a){var b=0;return c(a,function(){b+=1}),b},e=function(a){var b,c;return 1===arguments.length?(b=a.name,c=a.port):(b=arguments[0],c=arguments[1]),b+"."+c},f=function(a){var b=a.split(".");return{name:b[0],port:b[1]}};b.objIterate=c,b.objLength=d,b.portEncode=e,b.portDecode=f,b.async=function(){var a;return a="undefined"==typeof process&&"undefined"!=typeof setTimeout?function(a){setTimeout(a,0)}:process.nextTick}()}(a,b),function(a,b){if(b.profiler={},"undefined"!=typeof localStorage){var c=function(a){return"FBP.profile.c."+a};b.profiler.load=function(a){var b=localStorage.getItem(c(a.name)),d=0,e=0;return b&&(b=b.split(","),d=parseFloat(b[0]),e=parseInt(b[1],10),isNaN(d)&&(d=0),isNaN(e)&&(e=0)),a.profile.interval=d,a.profile.counts=e,a},b.profiler.save=function(a){localStorage.setItem(c(a.name),a.profile.interval+","+a.profile.counts)},b.profiler.collect=function(a,b){a.profile.counts=a.profile.counts+1,a.profile.interval=(a.profile.interval+b)/a.profile.counts}}}(a,b),function(a,b){b.Runtime=function(c,d){var e=this;e.nname=c.name,e.arcs=c.arcs,e.states={},e.inputs={},e.callback=d||function(a){if(a)throw a},e.tic=Date.now(),b.objIterate(c.components,function(b){e.states[b]=a.component(b).state||{},e.inputs[b]={}}),e.inputs[c.name]={}},b.Runtime.prototype={addInput:function(c,d){var e=this,f=a.component(c.name);e.inputs[c.name][c.port]=d,b.objLength(e.inputs[c.name])===f.inPorts.length&&e.invokeComponent(f)},invokeComponent:function(a){var c,d,e,f=this,g=a.inPorts,h=a.outPorts,i=[],j=0;for(j;j<g.length;j+=1)i[j]=f.inputs[a.name][g[j]];for(j=0;j<h.length;j+=1)c=b.portEncode(a.name,h[j]),d=f.arcs[c],i[j+g.length]=f.outPortSender(d);e=Date.now(),a.body.apply(f.states[a.name],i),b.profiler.collect(a,Date.now()-e)},sendOutput:function(a,c,d){var e=this,f=d||null,g={interval:Date.now()-e.tic};f||(e.inputs[e.nname][c]=a,g.output=a,g.port=c,b.objIterate(b._n[e.nname].components,function(a){b.profiler.save(b._c[a])})),e.callback.apply(e,[f,g])},outPortSender:function(a){var c=this;return function(d,e){b.async(function(){d?c.sendOutput(null,null,d):a.end?c.sendOutput(e,b.portEncode(a)):c.addInput(a,e)})}}}}(a,b),function(a,b){var c={},d={},e=function(a,c){var d=new b.Runtime(this,c);b.objIterate(a,function(b){d.addInput(d.arcs[b],a[b])})},f=function(a,c){var f={},g={},h={init:function(a,c){f[a]=!0,g[b.portEncode(a,c)]={name:a,port:c}},connect:function(a,c,d,e){var h=b.portEncode(a,c);f[d]=!0,g[h]={name:d,port:e}},end:function(a,c){g[b.portEncode(a,c)]={name:a,port:c,end:!0}}},i={name:a,outputs:{}};return c(h),i.components=f,i.arcs=g,i.go=e.bind(i),d[a]=i,i},g=function(a){var c,f={name:a.name,outputs:{},components:{},arcs:{}},g="string"==typeof a.init?[a.init]:a.init,h="string"==typeof a.end?[a.end]:a.end;for(c=0;c<g.length;c+=1)f.arcs[g[c]]=b.portDecode(g[c]),f.components[f.arcs[g[c]].name]=!0;for(b.objIterate(a.connections,function(c){f.arcs[c]=b.portDecode(a.connections[c]),f.components[f.arcs[c].name]=!0}),c=0;c<h.length;c+=1)f.arcs[h[c]]=b.portDecode(h[c]),f.arcs[h[c]].end=!0;return f.go=e.bind(f),d[f.name]=f,f};a.component=function(a){if("string"==typeof a)return c[a];var d=a.name,e=a.body,f=a.state||{},g=null,h=null;if(c[d])return c[a];if(g="string"==typeof a.inPorts?[a.inPorts]:a.inPorts,h="string"==typeof a.outPorts?[a.outPorts]:a.outPorts,e.length!==g.length+h.length)throw"number of ports do not match between definition and function arguments";c[d]=b.profiler.load({name:d,inPorts:g,outPorts:h,body:e,state:f,profile:{}})},a.network=function(a){return d[a]},a.define=function(){var a;return a=2===arguments.length&&"string"==typeof arguments[0]?f(arguments[0],arguments[1]):g(arguments[0])},b._n=d,b._c=c}(a,b);var c=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=a),exports.FBP=a):c.FBP=a}();