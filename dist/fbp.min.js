/*
   FBP.js
   http://github.com/teaualune/fbpjs
   MIT License
*/
!function(){var a,b,c,d={},e={},f={},g=function(a,b){var c;for(c in a)a.hasOwnProperty(c)&&b(c)},h=function(a){var b=0;return g(a,function(){b+=1}),b},i=function(a){var b,c;return 1===arguments.length?(b=a.name,c=a.port):(b=arguments[0],c=arguments[1]),b+"."+c},j=function(a){var b=a.split(".");return{name:b[0],port:b[1]}},k=function(a){if(a)throw a},l=function(b,e){var f=this;f.nname=b.name,f.addInput=a,f.invokeComponent=c,f.sendOutput=n,f.arcs=b.arcs,f.states={},f.inputs={},f.callback=e||k,f.tic=Date.now(),g(b.components,function(a){f.states[a]=d.component(a).state||{},f.inputs[a]={}}),f.inputs[b.name]={}},m=function(a,b){var c=new l(this,b);g(a,function(b){c.addInput(c.arcs[b],a[b])})},n=function(a,b,c){var d=this,e=c||null,f={interval:Date.now()-d.tic};e||(d.inputs[d.nname][b]=a,f.output=a,f.port=b),d.callback.apply(d,[e,f])},o=function(a,b){var c={},d={},e={init:function(a,b){c[a]=!0,d[i(a,b)]={name:a,port:b}},connect:function(a,b,e,f){var g=i(a,b);c[e]=!0,d[g]={name:e,port:f}},end:function(a,b){d[i(a,b)]={name:a,port:b,end:!0}}},g={name:a,outputs:{}};return b(e),g.components=c,g.arcs=d,g.go=m.bind(g),f[a]=g,g},p=function(a){var b,c={name:a.name,outputs:{},components:{},arcs:{}},d="string"==typeof a.init?[a.init]:a.init,e="string"==typeof a.end?[a.end]:a.end;for(b=0;b<d.length;b+=1)c.arcs[d[b]]=j(d[b]),c.components[c.arcs[d[b]].name]=!0;for(g(a.connections,function(b){c.arcs[b]=j(a.connections[b]),c.components[c.arcs[b].name]=!0}),b=0;b<e.length;b+=1)c.arcs[e[b]]=j(e[b]),c.arcs[e[b]].end=!0;return c.go=m.bind(c),f[c.name]=c,c};a=function(a,b){var c=this,e=d.component(a.name);c.inputs[a.name][a.port]=b,h(c.inputs[a.name])===e.inPorts.length&&c.invokeComponent(e)},b=function(a){return function(b,c){var d=this;b?d.sendOutput(null,null,b):a.end?d.sendOutput(c,i(a)):d.addInput(a,c)}},c=function(a){var c,d,e=this,f=a.inPorts,g=a.outPorts,h=[],j=0;for(j;j<f.length;j+=1)h[j]=e.inputs[a.name][f[j]];for(j=0;j<g.length;j+=1)c=i(a.name,g[j]),d=e.arcs[c],h[j+f.length]=b(d).bind(e);a.body.apply(e.states[a.name],h)},d.component=function(a){if("string"==typeof a)return e[a];var b=a.name,c=a.body,d=a.state||{},f=null,g=null;if(e[b])throw"component has already defined";if(f="string"==typeof a.inPorts?[a.inPorts]:a.inPorts,g="string"==typeof a.outPorts?[a.outPorts]:a.outPorts,c.length!==f.length+g.length)throw"number of ports do not match between definition and function arguments";e[b]={name:b,inPorts:f,outPorts:g,body:c,state:d}},d.network=function(a){return f[a]},d.define=function(){var a;return a=2===arguments.length&&"string"==typeof arguments[0]?o(arguments[0],arguments[1]):p(arguments[0])};var q=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=d),exports.FBP=d):q.FBP=d}();