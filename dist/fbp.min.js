/*
    FBP.js
    http://github.com/teaualune/fbpjs
    MIT License
*/
!function(){var a={},b={};!function(a,b){var c=function(a,b){var c;for(c in a)a.hasOwnProperty(c)&&b(c,a[c])},d=function(a){var b=0;return c(a,function(){b+=1}),b},e=function(a){var b,c;return 1===arguments.length?(b=a.name,c=a.port):(b=arguments[0],c=arguments[1]),b+"."+c},f=function(a){var b=a.split(".");return{name:b[0],port:b[1]}};b.objIterate=c,b.objLength=d,b.portEncode=e,b.portDecode=f,b.async=function(){var a;return a="undefined"==typeof process&&"undefined"!=typeof setTimeout?function(a){setTimeout(a,0)}:process.nextTick}(),b.objMax=function(a){var b,d=0;return c(a,function(c){b=a[c].length,b>d&&(d=b)}),d}}(a,b),function(a,b){if(b.profiler={enabled:!0},"undefined"==typeof localStorage)return a.enableProfiler=function(){},void(b.profiler.enabled=!1);var c=function(a){return"FBP.profile.c."+a};b.profiler.timestamp=function(){return"object"==typeof process&&"function"==typeof process.hrtime?function(){var a=process.hrtime();return 1e3*a[0]+a[1]/1e6}:"object"==typeof performance&&"function"==typeof performance.now?function(){return performance.now()}:function(){return Date.now()}}(),b.profiler._load=function(a){var b=localStorage.getItem(c(a)),d=0,e=0;return b&&(b=b.split(","),d=parseFloat(b[0]),e=parseInt(b[1],10),isNaN(d)&&(d=0),isNaN(e)&&(e=0)),{interval:d,counts:e}},b.profiler._save=function(a,b){localStorage.setItem(c(a),b.interval+","+b.counts)},b.profiler.load=function(a){a.profile=[]},b.profiler.save=function(a,c){for(var d=b.profiler._load(a.name),c=0,e=a.profile.length,f=0;e>f;f+=1)c+=a.profile.pop();d.interval=(d.interval*d.counts+c)/(d.counts+e),d.counts+=e,b.profiler._save(a.name,d)},b.profiler.average=function(a){for(var b=0,c=a.length,d=0;c>d;d+=1)b+=a[d];return b/c},b.profiler.collect=function(a,b){a.profile.push(b)},a.enableProfiler=function(a){b.profiler.enabled=a}}(a,b),function(a,b){b.Runtime=function(c,d){var e=this;e.nname=c.name,e.arcs=c.arcs,e.states={},e.inputs={},e.callback=d||function(a){if(a)throw a},b.profiler.enabled&&(e.tic=b.profiler.timestamp()),b.objIterate(c.components,function(b){e.states[b]=a.component(b).state||{},e.inputs[b]={}}),e.inputs[c.name]={}},b.Runtime.prototype={addInput:function(c,d){var e=this,f=a.component(c.name);e.inputs[c.name][c.port]=d,b.objLength(e.inputs[c.name])===f.inPorts.length&&(c.map?e.mapInvoke(f):e.invokeComponent(f))},invokeComponent:function(a){var c,d,e,f=this,g=a.inPorts,h=a.outPorts,i=[],j=0;for(j;j<g.length;j+=1)i[j]=f.inputs[a.name][g[j]];for(j=0;j<h.length;j+=1)c=b.portEncode(a.name,h[j]),d=f.arcs[c],i[j+g.length]=f.outPortSender(d);b.profiler.enabled&&(e=b.profiler.timestamp()),a.body.apply(f.states[a.name],i),b.profiler.enabled&&b.profiler.collect(a,b.profiler.timestamp()-e)},sendOutput:function(a,c,d){var e=this,f=d||null,g={};b.profiler.enabled&&(g.interval=b.profiler.timestamp()-e.tic),f||(e.inputs[e.nname][c]=a,g.output=a,g.port=c,b.profiler.enabled&&(g.profile={},b.objIterate(b._n[e.nname].components,function(a){var c=b._c[a];g.profile[a]=b.profiler.average(c.profile),b.profiler.save(c)}))),e.callback.apply(e,[f,g])},outPortSender:function(a){var c=this;return function(d,e){b.async(function(){d?c.sendOutput(null,null,d):a.end?c.sendOutput(e,b.portEncode(a)):c.addInput(a,e)})}},mapInvoke:function(a){var c,d=this,e=a.inPorts,f=a.outPorts,g=0,h=0,i=d.inputs[a.name],j=b.objMax(i),k=Array(j),l=Array(f.length),m=Array(f.length);for(g=0;j>g;g+=1){for(c=Array(e.length+f.length),h=0;h<e.length;h+=1)c[h]=i[e[h]][g];k[g]=c}for(g=0;g<f.length;g+=1)l[g]=Array(j),m[g]=0;for(g=0;j>g;g+=1)!function(c){var g=0,h=k[c];for(g;g<f.length;g+=1)h[g+e.length]=function(a,b){var e=d.arcs[b];return function(f,g){l[a][c]=f?null:g,m[a]+=1,m[a]===j&&(e.end?d.sendOutput(l[a],b):d.addInput(e,l[a]))}}(g,b.portEncode(a.name,f[g]));b.async(function(){if(b.profiler.enabled)var c=b.profiler.timestamp();a.body.apply(d.states[a.name],h),b.profiler.enabled&&b.profiler.collect(a,b.profiler.timestamp()-c)})}(g)}}}(a,b),function(a,b){var c={},d={},e=function(a,c){var d=new b.Runtime(this,c);b.objIterate(a,function(a,b){d.addInput(d.arcs[a],b)})},f=function(a,c){var f={},g={},h={init:function(a,c){f[a]=!0,g[b.portEncode(a,c)]={name:a,port:c}},connect:function(a,c,d,e,h){var i=b.portEncode(a,c);f[d]=!0,g[i]={name:d,port:e},h&&(g[i].map=h.map)},end:function(a,c){g[b.portEncode(a,c)]={name:a,port:c,end:!0}}},i={name:a,outputs:{}};return c(h),i.components=f,i.arcs=g,i.go=e.bind(i),d[a]=i,i},g=function(a){var c,f={name:a.name,outputs:{},components:{},arcs:{}},g="string"==typeof a.init?[a.init]:a.init,h="string"==typeof a.end?[a.end]:a.end;for(c=0;c<g.length;c+=1)f.arcs[g[c]]=b.portDecode(g[c]),f.components[f.arcs[g[c]].name]=!0;for(b.objIterate(a.connections,function(a,c){"string"==typeof c?f.arcs[a]=b.portDecode(c):(f.arcs[a]=b.portDecode(c.to),f.arcs[a].map=c.map),f.components[f.arcs[a].name]=!0}),c=0;c<h.length;c+=1)f.arcs[h[c]]=b.portDecode(h[c]),f.arcs[h[c]].end=!0;return f.go=e.bind(f),d[f.name]=f,f};a.component=function(a){if("string"==typeof a)return c[a];var d,e=a.name,f=a.body,g=a.state||{},h=null,i=null;if(c[e])return c[a];if(h="string"==typeof a.inPorts?[a.inPorts]:a.inPorts,i="string"==typeof a.outPorts?[a.outPorts]:a.outPorts,f.length!==h.length+i.length)throw"number of ports do not match between definition and function arguments";d={name:e,inPorts:h,outPorts:i,body:f,state:g},c[e]=d,b.profiler.enabled&&b.profiler.load(d)},a.network=function(a){return d[a]},a.define=function(){var a;return a=2===arguments.length&&"string"==typeof arguments[0]?f(arguments[0],arguments[1]):g(arguments[0])},b._n=d,b._c=c}(a,b);var c=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=a),exports.FBP=a):c.FBP=a}();