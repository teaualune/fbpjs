/*
    FBP.js
    http://github.com/teaualune/fbpjs
    MIT License
*/
!function(){var a={};a.utils={objIterate:function(a,b){var c;for(c in a)a.hasOwnProperty(c)&&b(c)},objLength:function(b){var c=0;return a.utils.objIterate(b,function(){c+=1}),c},portEncode:function(a){var b,c;return 1===arguments.length?(b=a.name,c=a.port):(b=arguments[0],c=arguments[1]),b+"."+c},portDecode:function(a){var b=a.split(".");return{name:b[0],port:b[1]}}};var b,c,d,e={},f={},g=function(a){if(a)throw a},h=function(c,e){var f=this;f.nname=c.name,f.addInput=b,f.invokeComponent=d,f.sendOutput=j,f.arcs=c.arcs,f.states={},f.inputs={},f.callback=e||g,f.tic=Date.now(),a.utils.objIterate(c.components,function(b){f.states[b]=a.component(b).state||{},f.inputs[b]={}}),f.inputs[c.name]={}},i=function(b,c){var d=new h(this,c);a.utils.objIterate(b,function(a){d.addInput(d.arcs[a],b[a])})},j=function(a,b,c){var d=this,e=c||null,f={interval:Date.now()-d.tic};e||(d.inputs[d.nname][b]=a,f.output=a,f.port=b),d.callback.apply(d,[e,f])},k=function(b,c){var d={},e={},g={init:function(b,c){d[b]=!0,e[a.utils.portEncode(b,c)]={name:b,port:c}},connect:function(b,c,f,g){var h=a.utils.portEncode(b,c);d[f]=!0,e[h]={name:f,port:g}},end:function(b,c){e[a.utils.portEncode(b,c)]={name:b,port:c,end:!0}}},h={name:b,outputs:{}};return c(g),h.components=d,h.arcs=e,h.go=i.bind(h),f[b]=h,h},l=function(b){var c,d={name:b.name,outputs:{},components:{},arcs:{}},e="string"==typeof b.init?[b.init]:b.init,g="string"==typeof b.end?[b.end]:b.end;for(c=0;c<e.length;c+=1)d.arcs[e[c]]=a.utils.portDecode(e[c]),d.components[d.arcs[e[c]].name]=!0;for(a.utils.objIterate(b.connections,function(c){d.arcs[c]=a.utils.portDecode(b.connections[c]),d.components[d.arcs[c].name]=!0}),c=0;c<g.length;c+=1)d.arcs[g[c]]=a.utils.portDecode(g[c]),d.arcs[g[c]].end=!0;return d.go=i.bind(d),f[d.name]=d,d};b=function(b,c){var d=this,e=a.component(b.name);d.inputs[b.name][b.port]=c,a.utils.objLength(d.inputs[b.name])===e.inPorts.length&&d.invokeComponent(e)},c=function(b){return function(c,d){var e=this;c?e.sendOutput(null,null,c):b.end?e.sendOutput(d,a.utils.portEncode(b)):e.addInput(b,d)}},d=function(b){var d,e,f=this,g=b.inPorts,h=b.outPorts,i=[],j=0;for(j;j<g.length;j+=1)i[j]=f.inputs[b.name][g[j]];for(j=0;j<h.length;j+=1)d=a.utils.portEncode(b.name,h[j]),e=f.arcs[d],i[j+g.length]=c(e).bind(f);b.body.apply(f.states[b.name],i)},a.component=function(a){if("string"==typeof a)return e[a];var b=a.name,c=a.body,d=a.state||{},f=null,g=null;if(e[b])throw"component has already defined";if(f="string"==typeof a.inPorts?[a.inPorts]:a.inPorts,g="string"==typeof a.outPorts?[a.outPorts]:a.outPorts,c.length!==f.length+g.length)throw"number of ports do not match between definition and function arguments";e[b]={name:b,inPorts:f,outPorts:g,body:c,state:d}},a.network=function(a){return f[a]},a.define=function(){var a;return a=2===arguments.length&&"string"==typeof arguments[0]?k(arguments[0],arguments[1]):l(arguments[0])};var m=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=a),exports.FBP=a):m.FBP=a}();