/*
    FBP.js
    http://github.com/teaualune/fbpjs
    MIT License
*/
!function(){var a={};a.utils={objIterate:function(a,b){var c;for(c in a)a.hasOwnProperty(c)&&b(c)},objLength:function(b){var c=0;return a.utils.objIterate(b,function(){c+=1}),c}};var b,c,d,e={},f={},g=function(a){var b,c;return 1===arguments.length?(b=a.name,c=a.port):(b=arguments[0],c=arguments[1]),b+"."+c},h=function(a){var b=a.split(".");return{name:b[0],port:b[1]}},i=function(a){if(a)throw a},j=function(c,e){var f=this;f.nname=c.name,f.addInput=b,f.invokeComponent=d,f.sendOutput=l,f.arcs=c.arcs,f.states={},f.inputs={},f.callback=e||i,f.tic=Date.now(),a.utils.objIterate(c.components,function(b){f.states[b]=a.component(b).state||{},f.inputs[b]={}}),f.inputs[c.name]={}},k=function(b,c){var d=new j(this,c);a.utils.objIterate(b,function(a){d.addInput(d.arcs[a],b[a])})},l=function(a,b,c){var d=this,e=c||null,f={interval:Date.now()-d.tic};e||(d.inputs[d.nname][b]=a,f.output=a,f.port=b),d.callback.apply(d,[e,f])},m=function(a,b){var c={},d={},e={init:function(a,b){c[a]=!0,d[g(a,b)]={name:a,port:b}},connect:function(a,b,e,f){var h=g(a,b);c[e]=!0,d[h]={name:e,port:f}},end:function(a,b){d[g(a,b)]={name:a,port:b,end:!0}}},h={name:a,outputs:{}};return b(e),h.components=c,h.arcs=d,h.go=k.bind(h),f[a]=h,h},n=function(b){var c,d={name:b.name,outputs:{},components:{},arcs:{}},e="string"==typeof b.init?[b.init]:b.init,g="string"==typeof b.end?[b.end]:b.end;for(c=0;c<e.length;c+=1)d.arcs[e[c]]=h(e[c]),d.components[d.arcs[e[c]].name]=!0;for(a.utils.objIterate(b.connections,function(a){d.arcs[a]=h(b.connections[a]),d.components[d.arcs[a].name]=!0}),c=0;c<g.length;c+=1)d.arcs[g[c]]=h(g[c]),d.arcs[g[c]].end=!0;return d.go=k.bind(d),f[d.name]=d,d};b=function(b,c){var d=this,e=a.component(b.name);d.inputs[b.name][b.port]=c,a.utils.objLength(d.inputs[b.name])===e.inPorts.length&&d.invokeComponent(e)},c=function(a){return function(b,c){var d=this;b?d.sendOutput(null,null,b):a.end?d.sendOutput(c,g(a)):d.addInput(a,c)}},d=function(a){var b,d,e=this,f=a.inPorts,h=a.outPorts,i=[],j=0;for(j;j<f.length;j+=1)i[j]=e.inputs[a.name][f[j]];for(j=0;j<h.length;j+=1)b=g(a.name,h[j]),d=e.arcs[b],i[j+f.length]=c(d).bind(e);a.body.apply(e.states[a.name],i)},a.component=function(a){if("string"==typeof a)return e[a];var b=a.name,c=a.body,d=a.state||{},f=null,g=null;if(e[b])throw"component has already defined";if(f="string"==typeof a.inPorts?[a.inPorts]:a.inPorts,g="string"==typeof a.outPorts?[a.outPorts]:a.outPorts,c.length!==f.length+g.length)throw"number of ports do not match between definition and function arguments";e[b]={name:b,inPorts:f,outPorts:g,body:c,state:d}},a.network=function(a){return f[a]},a.define=function(){var a;return a=2===arguments.length&&"string"==typeof arguments[0]?m(arguments[0],arguments[1]):n(arguments[0])};var o=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=a),exports.FBP=a):o.FBP=a}();